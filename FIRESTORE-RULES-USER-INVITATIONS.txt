rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to get current user ID
    function getUserId() {
      return request.auth.uid;
    }
    
    // ==================== USERS COLLECTION ====================
    // Store user profiles (created on first login)
    match /users/{userId} {
      // Anyone can read user profiles (for looking up by email)
      allow read: if isAuthenticated();
      
      // Users can create/update their own profile
      allow create, update: if isAuthenticated() && getUserId() == userId;
      
      // Users can delete their own profile
      allow delete: if isAuthenticated() && getUserId() == userId;
    }
    
    // ==================== INVITATIONS COLLECTION ====================
    match /invitations/{invitationId} {
      // Users can read invitations where they are sender or receiver
      allow read: if isAuthenticated() && 
                     (resource.data.sender_id == getUserId() ||
                      resource.data.receiver_id == getUserId());
      
      // Users can create invitations (as sender)
      allow create: if isAuthenticated() && 
                       request.resource.data.sender_id == getUserId() &&
                       request.resource.data.status == 'pending';
      
      // Receiver can update status (accept/reject)
      // Sender can also update (e.g., cancel)
      allow update: if isAuthenticated() && 
                       (resource.data.receiver_id == getUserId() ||
                        resource.data.sender_id == getUserId());
      
      // Sender or receiver can delete
      allow delete: if isAuthenticated() && 
                       (resource.data.sender_id == getUserId() ||
                        resource.data.receiver_id == getUserId());
    }
    
    // ==================== EXISTING COLLECTIONS ====================
    
    // Tasks
    match /tasks/{taskId} {
      allow read, write: if isAuthenticated() && 
                            (resource.data.userId == getUserId() || 
                             request.resource.data.userId == getUserId());
    }
    
    // Categories
    match /categories/{categoryId} {
      allow read, write: if isAuthenticated() && 
                            (resource.data.userId == getUserId() || 
                             request.resource.data.userId == getUserId());
    }
    
    // Notes
    match /notes/{noteId} {
      allow read, write: if isAuthenticated() && 
                            (resource.data.userId == getUserId() || 
                             request.resource.data.userId == getUserId());
    }
    
    // Simple invites (old system)
    match /invites/{inviteId} {
      allow create: if isAuthenticated() && 
                       request.resource.data.invitedBy == getUserId();
      
      allow read: if isAuthenticated() && 
                     (resource.data.invitedBy == getUserId() ||
                      resource.data.invitedEmail == request.auth.token.email);
      
      allow update, delete: if isAuthenticated() && 
                               resource.data.invitedBy == getUserId();
    }
    
    // Workspace collections
    match /workspaces/{workspaceId} {
      allow read, write: if isAuthenticated();
    }
    
    match /workspaceMembers/{memberId} {
      allow read, write: if isAuthenticated();
    }
    
    match /workspaceInvites/{inviteId} {
      allow read, write: if isAuthenticated();
    }
    
    match /workspaceInvitations/{invitationId} {
      allow create: if isAuthenticated() && 
                       request.resource.data.invitedBy == getUserId();
      
      allow read: if isAuthenticated() && 
                     (resource.data.invitedEmail == request.auth.token.email ||
                      resource.data.invitedBy == getUserId());
      
      allow update: if isAuthenticated() && 
                       (resource.data.invitedEmail == request.auth.token.email ||
                        resource.data.invitedBy == getUserId());
      
      allow delete: if isAuthenticated() && 
                       (resource.data.invitedBy == getUserId() ||
                        resource.data.invitedEmail == request.auth.token.email);
    }
    
    match /userWorkspaces/{userWorkspaceId} {
      allow read, write: if isAuthenticated();
    }
  }
}
